name: Fetch Binance USDC Prices

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main
    paths:
      - 'binance_usdc_prices.py'

permissions:
  contents: write

jobs:
  fetch-prices:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests
          
      - name: Fetch all USDC prices
        run: |
          python binance_usdc_prices.py all > prices_output.txt 2>&1
          
      - name: Fetch detailed stats for major pairs
        run: |
          echo "" >> prices_output.txt
          echo "==================================================" >> prices_output.txt
          echo "DETAILED 24H STATISTICS FOR MAJOR PAIRS" >> prices_output.txt
          echo "==================================================" >> prices_output.txt
          python binance_usdc_prices.py BTCUSDC --full >> prices_output.txt 2>&1
          echo "" >> prices_output.txt
          python binance_usdc_prices.py ETHUSDC --full >> prices_output.txt 2>&1
          echo "" >> prices_output.txt
          python binance_usdc_prices.py BNBUSDC --full >> prices_output.txt 2>&1
          
      - name: Create JSON output for easy parsing
        run: |
          python - <<'EOF'
          import json
          from binance_usdc_prices import BinanceUSDCPriceFetcher
          from datetime import datetime

          fetcher = BinanceUSDCPriceFetcher()

          # Get all prices
          all_prices = fetcher.get_all_usdc_prices()
          
          # Get detailed stats for major pairs
          major_pairs = ['BTCUSDC', 'ETHUSDC', 'BNBUSDC', 'SOLUSDC', 'ADAUSDC', 'DOGEUSDC']
          detailed_stats = {}
          
          for pair in major_pairs:
              try:
                  stats = fetcher.get_ticker_24h(pair)
                  if stats:
                      detailed_stats[pair] = stats
              except:
                  pass

          output = {
              'timestamp': datetime.utcnow().isoformat() + 'Z',
              'all_prices': all_prices,
              'major_pairs_24h_stats': detailed_stats
          }

          with open('prices_data.json', 'w') as f:
              json.dump(output, f, indent=2)
          
          print(f"Fetched {len(all_prices)} USDC pairs")
          print(f"Detailed stats for {len(detailed_stats)} major pairs")
          EOF
          
      - name: Generate human-readable summary
        run: |
          python - <<'EOF'
          import json
          from datetime import datetime

          with open('prices_data.json', 'r') as f:
              data = json.load(f)

          with open('PRICE_SUMMARY.md', 'w') as f:
              f.write(f"# Binance USDC Prices\n\n")
              f.write(f"**Last Updated:** {data['timestamp']}\n\n")
              
              f.write(f"## Major Pairs (24h Stats)\n\n")
              for pair, stats in data['major_pairs_24h_stats'].items():
                  base = pair.replace('USDC', '')
                  price = float(stats['lastPrice'])
                  change = float(stats['priceChangePercent'])
                  high = float(stats['highPrice'])
                  low = float(stats['lowPrice'])
                  volume = float(stats['volume'])
                  
                  emoji = "ðŸŸ¢" if change >= 0 else "ðŸ”´"
                  f.write(f"### {emoji} {base}/USDC\n\n")
                  f.write(f"- **Price:** ${price:,.2f}\n")
                  f.write(f"- **24h Change:** {change:+.2f}%\n")
                  f.write(f"- **24h High:** ${high:,.2f}\n")
                  f.write(f"- **24h Low:** ${low:,.2f}\n")
                  f.write(f"- **24h Volume:** {volume:,.2f} {base}\n\n")
              
              f.write(f"## All USDC Pairs ({len(data['all_prices'])} pairs)\n\n")
              f.write(f"| Pair | Price (USDC) |\n")
              f.write(f"|------|-------------:|\n")
              
              # Sort by symbol
              for pair in sorted(data['all_prices'].keys()):
                  price = float(data['all_prices'][pair])
                  f.write(f"| {pair} | {price:,.8f} |\n")
          
          print("Summary generated successfully")
          EOF
          
      - name: Commit and push if changed
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add prices_output.txt prices_data.json PRICE_SUMMARY.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update Binance USDC prices - $(date -u)" && git push)
